<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plano de Bodega Crisoull</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- QRCode.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- html2canvas CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- XLSX CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans min-h-screen p-6">
  <!-- Encabezado con reloj y título -->
  <header class="bg-gray-800 text-white p-4 rounded-lg mb-6">
    <h1 class="text-2xl text-center font-bold">Plano Bodega - Crisoull - </h1>
    <div class="text-center mt-2">
      <span id="clock" class="text-lg font-mono">00:00:00</span>
    </div>
  </header>

  <!-- Menú de acciones -->
  <div class="menu flex flex-wrap justify-center gap-4 mb-6">
    <button id="addBodegaBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Agregar Bodega</button>
    <button id="backupBtn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Descargar Backup</button>
    <button id="downloadPdfBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-green-700">Descargar PDF</button>
    <button id="downloadExcelBtn" class="bg-teal-600 text-white px-4 py-2  rounded hover:bg-teal-700">Descargar Excel</button>
    <button onclick=window.location.href='../manager/i_manager.html' class="bg-green-600 text-white px-4 py-2 rounded hover:bg-purple-700">Volver a Crisoull</button>


    <button id="arrangeBodegasBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Ordenar Bodegas</button>
    <button id="editSelectedBtn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 hidden">Editar Seleccionados</button>
    <button id="toggleHistoryBtn" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">Mostrar/Ocultar Historial</button>
    <button id="deleteAllBodegasBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Eliminar Todas las Bodegas</button>
  </div>

  <!-- Historial de cambios -->
  <div id="historyPanel" class="hidden bg-white p-4 rounded-lg shadow-lg mb-6 max-h-64 overflow-y-auto">
    <h2 class="text-lg font-semibold mb-2">Historial de Cambios</h2>
    <ul id="historyList" class="list-disc pl-5"></ul>
  </div>

  <!-- Contenedor de bodegas -->
  <div id="bodegasContainer" class="relative min-h-[600px] w-full"></div>

  <!-- Modal para gestión de inventarios -->
  <div id="inventoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Inventario de <span id="inventoryEstanteId"></span></h2>
      <div id="inventoryList" class="max-h-64 overflow-y-auto mb-4"></div>
      <div class="mb-4">
        <input id="newItemName" type="text" placeholder="Nombre del ítem" class="w-full p-2 border rounded text-sm">
        <input id="newItemQuantity" type="number" placeholder="Cantidad" min="0" class="w-full p-2 border rounded text-sm mt-2">
        <input id="newItemCategory" type="text" placeholder="Categoría" class="w-full p-2 border rounded text-sm mt-2">
      </div>
      <div class="flex justify-end gap-2">
        <button id="addItemBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Agregar Ítem</button>
        <button id="closeInventoryModal" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal para edición masiva -->
  <div id="editSelectedModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Editar Estantes Seleccionados</h2>
      <div class="mb-4">
        <input id="editName" type="text" placeholder="Nombre (opcional)" class="w-full p-2 border rounded text-sm">
        <input id="editColor" type="color" class="w-full p-2 border rounded h-8 mt-2">
      </div>
      <div class="flex justify-end gap-2">
        <button id="applyEditBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Aplicar</button>
        <button id="closeEditModal" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let dragged = null;
    let draggedBodega = null;
    let offsetX = 0;
    let offsetY = 0;
    let saveTimeout;
    let historyLog = [];
    let offlineQueue = [];
    let selectedEstantes = [];
    let currentParent = null;
    let navigationStack = [];
    const DRAG_DELAY = 200; // 200ms para diferenciar clic de arrastre

    // Reloj en tiempo real
    function updateClock() {
      try {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        console.error('Error en updateClock:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo actualizar el reloj.' });
      }
    }

    // Gestión del historial
    function addHistoryEntry(action, details) {
      try {
        const timestamp = new Date().toLocaleString('es-ES');
        const entry = { timestamp, action, details };
        historyLog.unshift(entry);
        if (historyLog.length > 50) historyLog.pop();
        localStorage.setItem('bodegaHistory', JSON.stringify(historyLog));
        renderHistory();
      } catch (e) {
        console.error('Error en addHistoryEntry:', e);
      }
    }

    function openToolManager() {
      try {
        const toolManager = document.getElementById('toolManager');
        if (toolManager) {
          toolManager.classList.toggle('hidden');
        } else {
          Swal.fire({
            title: 'Tool Manager',
            html: '<p>Herramientas de gestión de bodegas.</p>',
            showCloseButton: true,
            showCancelButton: false,
            focusConfirm: false,
            confirmButtonText: 'Cerrar'
          });
        }
      } catch (e) {
        console.error('Error en openToolManager:', e);
      }
    }
    
    function renderHistory() {
      try {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = historyLog.map(entry => `
          <li class="text-sm text-gray-700">${entry.timestamp} - ${entry.action}: ${entry.details}</li>
        `).join('');
      } catch (e) {
        console.error('Error en renderHistory:', e);
      }
    }

    function loadHistory() {
      try {
        const savedHistory = localStorage.getItem('bodegaHistory');
        if (savedHistory) {
          historyLog = JSON.parse(savedHistory);
          renderHistory();
        }
      } catch (e) {
        console.error('Error en loadHistory:', e);
      }
    }

    // Verificar localStorage
    function isLocalStorageAvailable() {
      try {
        const test = '__test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch (e) {
        console.error('localStorage no disponible:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'localStorage no está disponible.' });
        return false;
      }
    }

    // Sincronización offline
    function queueAction(action, data) {
      try {
        offlineQueue.push({ action, data, timestamp: new Date().toISOString() });
        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
        addHistoryEntry('Acción Offline', `Acción ${action} encolada`);
      } catch (e) {
        console.error('Error en queueAction:', e);
      }
    }

    async function syncOfflineQueue() {
      if (!navigator.onLine || offlineQueue.length === 0) return;
      try {
        for (const item of [...offlineQueue]) {
          console.log('Sincronizando:', item);
          offlineQueue = offlineQueue.filter(i => i !== item);
          localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
          addHistoryEntry('Sincronización', `Acción ${item.action} sincronizada`);
        }
      } catch (error) {
        console.error('Error al sincronizar:', error);
        addHistoryEntry('Error Sincronización', error.message);
      }
    }

    function loadOfflineQueue() {
      try {
        const savedQueue = localStorage.getItem('offlineQueue');
        if (savedQueue) offlineQueue = JSON.parse(savedQueue);
        if (navigator.onLine) syncOfflineQueue();
      } catch (e) {
        console.error('Error en loadOfflineQueue:', e);
      }
    }

    // Generar ID único
    function generateCoordinateId(x, y) {
      try {
        const col = String.fromCharCode(65 + Math.floor(x / 150));
        const row = Math.floor(y / 150) + 1;
        const id = `${col}${row}-${Date.now()}`;
        console.log('ID generado:', id);
        return id;
      } catch (e) {
        console.error('Error en generateCoordinateId:', e);
        return `EST${Date.now()}`;
      }
    }

    // Actualizar código QR
    function updateQRCode(estante) {
      try {
        const id = estante.id;
        const bodega = estante.closest('.bodega')?.querySelector('h2')?.textContent || 'Sin bodega';
        const nombre = estante.querySelector('input[type="text"]').value || 'Sin nombre';
        const fecha = estante.querySelector('input[type="date"]').value || 'Sin fecha';
        const peso = estante.querySelector('input[type="number"]').value || '0';
        const x = parseFloat(estante.style.left) || 0;
        const y = parseFloat(estante.style.top) || 0;
        const qrData = {
          ID: id,
          Bodega: bodega,
          Nombre: nombre,
          Fecha: fecha,
          Peso: `${peso} kg`,
          Coordenadas: { x: x.toFixed(0), y: y.toFixed(0) }
        };

        const qrDiv = estante.querySelector('.qr-code');
        qrDiv.innerHTML = '';
        new QRCode(qrDiv, {
          text: JSON.stringify(qrData),
          width: 100,
          height: 100
        });

        estante.dataset.qrData = JSON.stringify(qrData);
        console.log('QR actualizado para estante:', id);
      } catch (e) {
        console.error('Error en updateQRCode:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo generar el QR.' });
      }
    }

    // Mostrar vista previa del QR
    function previewQR(button) {
      try {
        const estante = button.closest('.estante');
        const qrData = estante.dataset.qrData ? JSON.parse(estante.dataset.qrData) : {};
        Swal.fire({
          title: 'Contenido del QR',
          html: `<pre class="text-left text-sm">${JSON.stringify(qrData, null, 2)}</pre>`,
          confirmButtonText: 'Cerrar'
        });
      } catch (e) {
        console.error('Error en previewQR:', e);
      }
    }

    // Copiar contenido del QR
    function copyQRContent(button) {
      try {
        const estante = button.closest('.estante');
        const qrData = estante.dataset.qrData || '{}';
        navigator.clipboard.writeText(qrData).then(() => {
          Swal.fire({
            icon: 'success',
            title: 'Copiado',
            text: 'Contenido del QR copiado al portapapeles.',
            showConfirmButton: false,
            timer: 1500
          });
        });
      } catch (e) {
        console.error('Error en copyQRContent:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo copiar el contenido.' });
      }
    }

    // Actualizar coordenadas
    function updateCoordinates(estante) {
      try {
        const x = parseFloat(estante.style.left) || 0;
        const y = parseFloat(estante.style.top) || 0;
        const coordsDiv = estante.querySelector('.estante-coords');
        coordsDiv.textContent = `Coords: (${x.toFixed(0)}, ${y.toFixed(0)})`;
      } catch (e) {
        console.error('Error en updateCoordinates:', e);
      }
    }

    // Ajustar tamaño del contenedor padre
    function adjustParentSize(parent) {
      try {
        const isBodega = parent.classList.contains('bodega');
        const container = isBodega ? parent.querySelector('.estantes') : parent.querySelector('.sub-estantes');
        const children = container.querySelectorAll('.estante');
        let maxWidth = isBodega ? 400 : parseFloat(parent.style.width) || 140;
        let maxHeight = isBodega ? 400 : parseFloat(parent.style.height) || 280;

        children.forEach(child => {
          const x = parseFloat(child.style.left) || 0;
          const y = parseFloat(child.style.top) || 0;
          const width = child.offsetWidth;
          const height = child.offsetHeight;

          maxWidth = Math.max(maxWidth, x + width + 30);
          maxHeight = Math.max(maxHeight, y + height + 30);

          child.style.left = `${Math.min(x, maxWidth - width - 30)}px`;
          child.style.top = `${Math.min(y, maxHeight - height - 30)}px`;
        });

        if (isBodega) {
          parent.style.width = `${maxWidth}px`;
          container.style.height = `${maxHeight}px`;
        } else {
          parent.style.width = `${maxWidth}px`;
          parent.style.height = `${maxHeight}px`;
          container.style.width = `${maxWidth - 20}px`;
          container.style.height = `${maxHeight - 100}px`;
          const grandParent = parent.closest('.estante') || parent.closest('.bodega');
          if (grandParent) adjustParentSize(grandParent);
        }
      } catch (e) {
        console.error('Error en adjustParentSize:', e);
      }
    }

    // Gestión de inventarios
    let currentEstanteInventory = null;
    function openInventoryModal(estante) {
      try {
        currentEstanteInventory = estante;
        const estanteId = estante.id;
        const inventory = estante.dataset.inventory ? JSON.parse(estante.dataset.inventory) : [];
        document.getElementById('inventoryEstanteId').textContent = estanteId;
        renderInventoryList(inventory);
        document.getElementById('inventoryModal').classList.remove('hidden');
        console.log('Inventario abierto para estante:', estanteId);
      } catch (e) {
        console.error('Error en openInventoryModal:', e);
      }
    }

    function renderInventoryList(inventory) {
      try {
        const inventoryList = document.getElementById('inventoryList');
        inventoryList.innerHTML = inventory.length ? inventory.map((item, index) => `
          <div class="flex justify-between items-center p-2 border-b">
            <span class="text-sm">${item.name} (${item.quantity} - ${item.category})</span>
            <button class="bg-red-500 text-white text-xs px-2 py-1 rounded" onclick="deleteInventoryItem(${index})">Eliminar</button>
          </div>
        `).join('') : '<p class="text-sm text-gray-500">No hay ítems en el inventario.</p>';
      } catch (e) {
        console.error('Error en renderInventoryList:', e);
      }
    }

    function deleteInventoryItem(index) {
      try {
        const inventory = JSON.parse(currentEstanteInventory.dataset.inventory || '[]');
        inventory.splice(index, 1);
        currentEstanteInventory.dataset.inventory = JSON.stringify(inventory);
        renderInventoryList(inventory);
        addHistoryEntry('Eliminar Ítem', `Ítem eliminado del inventario de estante ${currentEstanteInventory.id}`);
        saveState();
        queueAction('updateEstante', { id: currentEstanteInventory.id, inventory });
      } catch (e) {
        console.error('Error en deleteInventoryItem:', e);
      }
    }

    // Navegar a un estante
    function navigateToEstante(estante) {
      try {
        navigationStack.push({ parent: currentParent, container: document.getElementById('bodegasContainer').innerHTML });
        localStorage.setItem('navigationStack', JSON.stringify(navigationStack));
        currentParent = estante;
        const container = document.getElementById('bodegasContainer');
        container.innerHTML = '';
        container.appendChild(estante.querySelector('.sub-estantes').cloneNode(true));
        addHistoryEntry('Navegar', `Navegado al estante ${estante.id}`);
      } catch (e) {
        console.error('Error en navigateToEstante:', e);
      }
    }

    // Agregar sub-estante
    function addSubEstante(estante) {
      try {
        const subEstantesDiv = estante.querySelector('.sub-estantes');
        const existingSubEstantes = subEstantesDiv.querySelectorAll('.estante');
        let newX = 10;
        let newY = 10;
        if (existingSubEstantes.length > 0) {
          const lastSubEstante = existingSubEstantes[existingSubEstantes.length - 1];
          newX = (parseFloat(lastSubEstante.style.left) || 0) + 150;
          newY = parseFloat(lastSubEstante.style.top) || 0;
        }
        const newSubEstante = createEstante(null, "", "", "", "", false, newX, newY, "#e9ecef", [], [], estante);
        adjustParentSize(estante);
        addHistoryEntry('Agregar Sub-Estante', `Sub-estante ${newSubEstante.id} agregado a estante ${estante.id}`);
        saveState();
        queueAction('addSubEstante', { estanteId: estante.id, subEstante: newSubEstante });
        console.log('Sub-estante creado:', newSubEstante.id);
      } catch (e) {
        console.error('Error en addSubEstante:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo agregar el sub-estante.' });
      }
    }

    // Crear estante
    function createEstante(id = null, nombre = "", fecha = "", peso = "", ficha = "", showId = false, x = 10, y = 10, color = "#e9ecef", inventory = [], subEstantes = [], parent = null) {
      try {
        const estante = document.createElement("div");
        estante.className = "estante bg-white border border-gray-300 rounded-lg p-4 absolute cursor-move shadow-md resize overflow-auto";
        estante.id = id || generateCoordinateId(x, y);
        estante.style.left = `${x}px`;
        estante.style.top = `${y}px`;
        estante.style.backgroundColor = color;
        estante.style.minWidth = '100px';
        estante.style.minHeight = '280px';
        estante.style.width = '140px';
        estante.dataset.inventory = JSON.stringify(inventory);

        estante.innerHTML = `
          <input type="checkbox" class="estante-checkbox absolute top-2 left-2" onchange="toggleEstanteSelection(this)">
          <div class="estante-id text-xs text-gray-500 ${showId ? '' : 'hidden'}">${estante.id}</div>
          <div class="estante-coords text-xs text-gray-500">Coords: (${x}, ${y})</div>
          <input type="text" placeholder="Nombre" value="${nombre}" class="w-full p-2 border rounded text-sm text-center" oninput="updateEstante(this)">
          <input type="date" value="${fecha}" class="w-full p-2 border rounded text-sm text-center" onchange="updateEstante(this)">
          <input type="number" placeholder="Peso (kg)" value="${peso}" min="0" step="0.1" class="w-full p-2 border rounded text-sm text-center" oninput="updateEstante(this)">
          <input type="url" placeholder="Ficha técnica" value="${ficha}" class="w-full p-2 border rounded text-sm text-center" oninput="updateEstante(this)">
          <input type="color" value="${color}" class="w-full h-8 p-1 border rounded cursor-pointer" onchange="updateEstante(this)">
          <div class="qr-code mx-auto my-2"></div>
          <div class="estante-actions flex flex-wrap gap-2 justify-center mt-2">
            <button class="btn-action bg-gray-500 text-white text-xs px-2 py-1 rounded" onclick="toggleId(this)">${showId ? 'Ocultar' : 'Mostrar'} ID</button>
            <button class="btn-action bg-yellow-500 text-white text-xs px-2 py-1 rounded" onclick="editEstante(this)">Editar</button>
            <button class="btn-action bg-blue-500 text-white text-xs px-2 py-1 rounded" onclick="openInventoryModal(this.closest('.estante'))">Inventario</button>
            
            <button class="btn-action bg-green-500 text-white text-xs px-2 py-1 rounded" onclick="addSubEstante(this.closest('.estante'))">+ Sub-Estante</button>
            <button class="btn-action bg-teal-500 text-white text-xs px-2 py-1 rounded" onclick="previewQR(this)">Vista Previa QR</button>
            <button class="btn-action bg-indigo-500 text-white text-xs px-2 py-1 rounded" onclick="copyQRContent(this)">Copiar QR</button>
            <button class="btn-action bg-red-500 text-white text-xs px-2 py-1 rounded" onclick="deleteEstante(this)">Eliminar</button>
          </div>
          <div class="sub-estantes relative mt-2" style="min-height: 100px;"></div>
        `;

        updateQRCode(estante);
        updateCoordinates(estante);

        const subEstantesDiv = estante.querySelector('.sub-estantes');
        subEstantes.forEach(sub => {
          const subEstante = createEstante(sub.id, sub.nombre, sub.fecha, sub.peso, sub.ficha, sub.showId, sub.x, sub.y, sub.color, sub.inventory, sub.subEstantes, estante);
          subEstantesDiv.appendChild(subEstante);
        });

        let dragTimer;
        estante.addEventListener("mousedown", (e) => {
          if (e.target.closest('.btn-action') || e.target.tagName === 'INPUT' || e.target.closest('.qr-code') || e.target.classList.contains('estante-checkbox')) return;
          dragTimer = setTimeout(() => {
            dragged = estante;
            const rect = estante.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            estante.style.zIndex = '1000';
            e.preventDefault();
            console.log('Arrastre iniciado para estante:', estante.id);
          }, DRAG_DELAY);
        });

        estante.addEventListener("mouseup", () => {
          clearTimeout(dragTimer);
        });

        estante.addEventListener("resize", () => {
          const parent = estante.closest('.estante') || estante.closest('.bodega');
          if (parent) adjustParentSize(parent);
          updateQRCode(estante);
          saveState();
        });

        const parentContainer = parent ? (parent.classList.contains('bodega') ? parent.querySelector('.estantes') : parent.querySelector('.sub-estantes')) : document.getElementById('bodegasContainer');
        parentContainer.appendChild(estante);
        if (parent) adjustParentSize(parent);

        console.log('Estante creado:', estante.id);
        return estante;
      } catch (e) {
        console.error('Error en createEstante:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo crear el estante.' });
      }
    }

    // Actualizar estante
    function updateEstante(input) {
      try {
        const estante = input.closest('.estante');
        const pesoInput = estante.querySelector('input[type="number"]');
        const colorInput = estante.querySelector('input[type="color"]');
        if (pesoInput.value && pesoInput.value < 0) {
          pesoInput.value = '';
          Swal.fire({ icon: 'error', title: 'Error', text: 'El peso no puede ser negativo.' });
        }
        estante.style.backgroundColor = colorInput.value;
        updateQRCode(estante);
        updateCoordinates(estante);
        const parent = estante.closest('.estante') || estante.closest('.bodega');
        if (parent) adjustParentSize(parent);
        addHistoryEntry('Actualizar Estante', `Estante ${estante.id} actualizado`);
        saveState();
        queueAction('updateEstante', {
          id: estante.id,
          nombre: estante.querySelector('input[type="text"]').value,
          color: colorInput.value
        });
      } catch (e) {
        console.error('Error en updateEstante:', e);
      }
    }

    // Mostrar/Ocultar ID
    function toggleId(button) {
      try {
        const estante = button.closest('.estante');
        const idDiv = estante.querySelector('.estante-id');
        idDiv.classList.toggle('hidden');
        button.textContent = idDiv.classList.contains('hidden') ? 'Mostrar ID' : 'Ocultar ID';
        saveState();
      } catch (e) {
        console.error('Error en toggleId:', e);
      }
    }

    // Editar estante
    function editEstante(button) {
      try {
        const estante = button.closest('.estante');
        Swal.fire({
          title: 'Editar Estante',
          html: `
            <input id="editName" type="text" placeholder="Nombre" value="${estante.querySelector('input[type="text"]').value}" class="w-full p-2 border rounded text-sm">
            <input id="editColor" type="color" value="${estante.querySelector('input[type="color"]').value}" class="w-full p-2 border rounded h-8 mt-2">
          `,
          showCancelButton: true,
          confirmButtonText: 'Guardar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            const name = document.getElementById('editName').value;
            const color = document.getElementById('editColor').value;
            estante.querySelector('input[type="text"]').value = name;
            estante.querySelector('input[type="color"]').value = color;
            estante.style.backgroundColor = color;
            updateQRCode(estante);
            addHistoryEntry('Editar Estante', `Estante ${estante.id} editado`);
            saveState();
            queueAction('updateEstante', { id: estante.id, nombre: name, color });
          }
        });
      } catch (e) {
        console.error('Error en editEstante:', e);
      }
    }

    // Eliminar estante
    function deleteEstante(button) {
      try {
        const estante = button.closest('.estante');
        Swal.fire({
          title: '¿Eliminar este estante?',
          text: 'Se eliminará el estante y sus subestantes.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#dc3545',
          cancelButtonText: 'Cancelar',
          confirmButtonText: 'Eliminar'
        }).then((result) => {
          if (result.isConfirmed) {
            const parent = estante.closest('.estante') || estante.closest('.bodega');
            estante.remove();
            if (parent) adjustParentSize(parent);
            addHistoryEntry('Eliminar Estante', `Estante ${estante.id} eliminado`);
            saveState();
            queueAction('deleteEstante', { id: estante.id });
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'El estante ha sido eliminado.',
              showConfirmButton: false,
              timer: 1500
            });
          }
        });
      } catch (e) {
        console.error('Error en deleteEstante:', e);
      }
    }

    // Seleccionar estante
    function toggleEstanteSelection(checkbox) {
      try {
        const estante = checkbox.closest('.estante');
        if (checkbox.checked) {
          selectedEstantes.push(estante);
          estante.classList.add('border-blue-500');
        } else {
          selectedEstantes = selectedEstantes.filter(e => e !== estante);
          estante.classList.remove('border-blue-500');
        }
        document.getElementById('editSelectedBtn').classList.toggle('hidden', selectedEstantes.length === 0);
      } catch (e) {
        console.error('Error en toggleEstanteSelection:', e);
      }
    }

    // Crear bodega
    function createBodega(name = "Nueva Bodega", estantes = [], x = 0, y = 0) {
      try {
        const bodega = document.createElement("div");
        bodega.className = "bodega bg-white border-2 border-gray-300 rounded-lg p-4 absolute shadow-lg flex flex-col resize overflow-auto";
        bodega.id = `BOD${Date.now()}`; // Asignar un ID único
        bodega.style.left = `${x}px`;
        bodega.style.top = `${y}px`;
        bodega.style.width = '400px';
        bodega.style.minHeight = '500px';

        const title = document.createElement("h2");
        title.className = "text-lg font-semibold bg-green-700 text-white p-2 rounded text-center cursor-move";
        title.textContent = name;
        title.contentEditable = true;
        title.addEventListener("input", () => {
          addHistoryEntry('Actualizar Bodega', `Bodega "${title.textContent}" renombrada`);
          saveState();
        });
        bodega.appendChild(title);

        const estantesDiv = document.createElement("div");
        estantesDiv.className = "estantes relative flex-grow min-h-[400px] p-2";
        bodega.appendChild(estantesDiv);

        const addEstanteBtn = document.createElement("button");
        addEstanteBtn.className = "bg-green-500 text-white px-3 py-2 rounded mx-auto mt-4 hover:bg-green-600";
        addEstanteBtn.textContent = "+ Estante";
        addEstanteBtn.onclick = () => {
          const existingEstantes = estantesDiv.querySelectorAll('.estante');
          let newX = 10;
          let newY = 10;
          if (existingEstantes.length > 0) {
            const lastEstante = existingEstantes[existingEstantes.length - 1];
            newX = (parseFloat(lastEstante.style.left) || 0) + 150;
            newY = parseFloat(lastEstante.style.top) || 0;
          }
          const newEstante = createEstante(null, "", "", "", "", false, newX, newY, "#e9ecef", [], [], bodega);
          adjustParentSize(bodega);
          addHistoryEntry('Agregar Estante', `Estante ${newEstante.id} agregado a bodega "${name}"`);
          saveState();
          queueAction('addEstante', { bodegaId: bodega.id, estante: newEstante });
        };
        bodega.appendChild(addEstanteBtn);

        const deleteBodegaBtn = document.createElement("button");
        deleteBodegaBtn.className = "bg-red-500 text-white px-3 py-2 rounded mt-2 hover:bg-red-600";
        deleteBodegaBtn.textContent = "Eliminar Bodega";
        deleteBodegaBtn.onclick = () => {
          Swal.fire({
            title: '¿Eliminar esta bodega?',
            text: "Se eliminará la bodega y todo su contenido.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Eliminar',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              addHistoryEntry('Eliminar Bodega', `Bodega "${name}" eliminada`);
              bodega.remove();
              saveState();
              queueAction('deleteBodega', { id: bodega.id });
              Swal.fire({
                icon: 'success',
                title: 'Eliminada',
                text: 'La bodega ha sido eliminada.',
                showConfirmButton: false,
                timer: 1500
              });
            }
          });
        };
        bodega.appendChild(deleteBodegaBtn);

        estantes.forEach(est => {
          createEstante(est.id, est.nombre, est.fecha, est.peso, est.ficha, est.showId, est.x, est.y, est.color, est.inventory, est.subEstantes, bodega);
        });

        document.getElementById("bodegasContainer").appendChild(bodega);
        adjustParentSize(bodega);

        // Configurar arrastre de bodega
        let dragTimer;
        title.addEventListener("mousedown", (e) => {
          if (e.target.tagName === 'INPUT') return;
          dragTimer = setTimeout(() => {
            draggedBodega = bodega;
            const rect = bodega.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            bodega.style.zIndex = '1000';
            e.preventDefault();
            console.log('Arrastre iniciado para bodega:', name);
          }, DRAG_DELAY);
        });

        title.addEventListener("mouseup", () => {
          clearTimeout(dragTimer);
        });

        bodega.addEventListener("resize", () => {
          adjustParentSize(bodega);
          saveState();
        });

        addHistoryEntry('Agregar Bodega', `Bodega "${name}" creada`);
        saveState();
        queueAction('addBodega', { name, x, y });
        console.log('Bodega creada:', name);
        return bodega;
      } catch (e) {
        console.error('Error en createBodega:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo crear la bodega.' });
      }
    }

    // Eliminar todas las bodegas
    function deleteAllBodegas() {
      try {
        Swal.fire({
          title: '¿Eliminar todas las bodegas?',
          text: "Se eliminarán todas las bodegas y sus contenidos. Esta acción no se puede deshacer.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Eliminar Todo',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            const container = document.getElementById('bodegasContainer');
            container.innerHTML = '';
            addHistoryEntry('Eliminar Todas las Bodegas', 'Todas las bodegas fueron eliminadas');
            localStorage.removeItem('bodegaData');
            saveState();
            queueAction('deleteAllBodegas', {});
            Swal.fire({
              icon: 'success',
              title: 'Eliminadas',
              text: 'Todas las bodegas han sido eliminadas.',
              showConfirmButton: false,
              timer: 1500
            });
          }
        });
      } catch (e) {
        console.error('Error en deleteAllBodegas:', e);
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudieron eliminar las bodegas.' });
      }
    }

    // Guardar estado
    function saveState() {
      if (!isLocalStorageAvailable()) return;
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        try {
          const bodegas = [];
          document.querySelectorAll(".bodega").forEach(bodega => {
            const title = bodega.querySelector("h2").textContent;
            const x = parseFloat(bodega.style.left) || 0;
            const y = parseFloat(bodega.style.top) || 0;
            const estantes = Array.from(bodega.querySelectorAll(".estantes > .estante")).map(est => ({
              id: est.id,
              nombre: est.querySelector('input[type="text"]').value,
              fecha: est.querySelector('input[type="date"]').value,
              peso: est.querySelector('input[type="number"]').value,
              ficha: est.querySelector('input[type="url"]').value,
              color: est.querySelector('input[type="color"]').value,
              showId: !est.querySelector('.estante-id').classList.contains('hidden'),
              x: parseFloat(est.style.left) || 10,
              y: parseFloat(est.style.top) || 10,
              inventory: est.dataset.inventory ? JSON.parse(est.dataset.inventory) : [],
              subEstantes: Array.from(est.querySelectorAll('.sub-estantes .estante')).map(sub => ({
                id: sub.id,
                nombre: sub.querySelector('input[type="text"]').value,
                fecha: sub.querySelector('input[type="date"]').value,
                peso: sub.querySelector('input[type="number"]').value,
                ficha: sub.querySelector('input[type="url"]').value,
                color: sub.querySelector('input[type="color"]').value,
                showId: !sub.querySelector('.estante-id').classList.contains('hidden'),
                x: parseFloat(sub.style.left) || 10,
                y: parseFloat(sub.style.top) || 10,
                inventory: sub.dataset.inventory ? JSON.parse(sub.dataset.inventory) : [],
                subEstantes: []
              }))
            }));
            bodegas.push({ title, estantes, x, y });
          });

          localStorage.setItem("bodegaData", JSON.stringify(bodegas));
        } catch (e) {
          console.error('Error en saveState:', e);
        }
      }, 500);
    }

    // Cargar estado
    function loadState() {
      if (!isLocalStorageAvailable()) return;
      try {
        const data = localStorage.getItem("bodegaData");
        if (data) {
          const bodegas = JSON.parse(data) || [];
          bodegas.forEach(b => createBodega(b.title, b.estantes, b.x, b.y));
        }
      } catch (e) {
        console.error('Error en loadState:', e);
      }
    }

    // Eventos globales de arrastre
    document.addEventListener('mousemove', (e) => {
      try {
        if (dragged) {
          const parent = dragged.closest('.estante') || dragged.closest('.bodega');
          const parentRect = parent ? parent.querySelector('.estantes, .sub-estantes').getBoundingClientRect() : document.getElementById('bodegasContainer').getBoundingClientRect();
          let newX = e.clientX - offsetX - parentRect.left;
          let newY = e.clientY - offsetY - parentRect.top;

          newX = Math.max(0, Math.min(newX, parentRect.width - dragged.offsetWidth - 30));
          newY = Math.max(0, Math.min(newY, parentRect.height - dragged.offsetHeight - 30));

          dragged.style.left = `${newX}px`;
          dragged.style.top = `${newY}px`;
          updateCoordinates(dragged);
          updateQRCode(dragged);
          if (parent) adjustParentSize(parent);
        } else if (draggedBodega) {
          const containerRect = document.getElementById('bodegasContainer').getBoundingClientRect();
          let newX = e.clientX - offsetX - containerRect.left;
          let newY = e.clientY - offsetY - containerRect.top;

          newX = Math.max(0, newX);
          newY = Math.max(0, newY);

          draggedBodega.style.left = `${newX}px`;
          draggedBodega.style.top = `${newY}px`;
        }
      } catch (e) {
        console.error('Error en mousemove:', e);
      }
    });

    document.addEventListener('mouseup', () => {
      try {
        if (dragged) {
          dragged.style.zIndex = '';
          const parent = dragged.closest('.estante') || dragged.closest('.bodega');
          if (parent) adjustParentSize(parent);
          addHistoryEntry('Mover Estante', `Estante ${dragged.id} movido a (${parseFloat(dragged.style.left).toFixed(0)}, ${parseFloat(dragged.style.top).toFixed(0)})`);
          saveState();
          queueAction('updateEstante', {
            id: dragged.id,
            x: parseFloat(dragged.style.left),
            y: parseFloat(dragged.style.top)
          });
          dragged = null;
        } else if (draggedBodega) {
          draggedBodega.style.zIndex = '';
          addHistoryEntry('Mover Bodega', `Bodega "${draggedBodega.querySelector('h2').textContent}" movida a (${parseFloat(draggedBodega.style.left).toFixed(0)}, ${parseFloat(draggedBodega.style.top).toFixed(0)})`);
          saveState();
          queueAction('updateBodega', {
            id: draggedBodega.id,
            x: parseFloat(draggedBodega.style.left),
            y: parseFloat(draggedBodega.style.top)
          });
          draggedBodega = null;
        }
      } catch (e) {
        console.error('Error en mouseup:', e);
      }
    });

    // Inicialización
    window.onload = () => {
      try {
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;

        // Verificar dependencias
        if (!window.Swal || !window.QRCode || !window.html2canvas || !window.jspdf || !window.XLSX) {
          throw new Error('Una o más dependencias no se cargaron correctamente');
        }

        // Inicializar reloj
        updateClock();
        setInterval(updateClock, 1000);

        // Cargar datos
        loadState();
        loadHistory();
        loadOfflineQueue();
        navigationStack = JSON.parse(localStorage.getItem('navigationStack') || '[]');

        // Configurar eventos
        document.getElementById('addBodegaBtn').addEventListener('click', () => {
          const container = document.getElementById("bodegasContainer");
          const existingBodegas = container.querySelectorAll('.bodega');
          const maxPerRow = 3;
          const bodegaWidth = 430;
          const bodegaHeight = 550;
          const gap = 30;

          const index = existingBodegas.length;
          const row = Math.floor(index / maxPerRow);
          const col = index % maxPerRow;
          const newX = col * (bodegaWidth + gap);
          const newY = row * (bodegaHeight + gap);

          createBodega("Nueva Bodega", [], newX, newY);
          console.log('Bodega agregada');
        });

        document.getElementById('toggleHistoryBtn').addEventListener('click', () => {
          const panel = document.getElementById('historyPanel');
          panel.classList.toggle('hidden');
        });

        document.getElementById('deleteAllBodegasBtn').addEventListener('click', deleteAllBodegas);

        document.getElementById('addItemBtn').addEventListener('click', () => {
          const name = document.getElementById('newItemName').value.trim();
          const quantity = document.getElementById('newItemQuantity').value;
 W
          const category = document.getElementById('newItemCategory').value.trim();

          if (!name || !quantity || !category) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Todos los campos son obligatorios.' });
            return;
          }

          const inventory = currentEstanteInventory.dataset.inventory ? JSON.parse(currentEstanteInventory.dataset.inventory) : [];
          inventory.push({ name, quantity: parseInt(quantity), category });
          currentEstanteInventory.dataset.inventory = JSON.stringify(inventory);
          renderInventoryList(inventory);
          document.getElementById('newItemName').value = '';
          document.getElementById('newItemQuantity').value = '';
          document.getElementById('newItemCategory').value = '';
          addHistoryEntry('Agregar Ítem', `Ítem "${name}" agregado al inventario de estante ${currentEstanteInventory.id}`);
          saveState();
          queueAction('updateEstante', { id: currentEstanteInventory.id, inventory });
        });

        document.getElementById('closeInventoryModal').addEventListener('click', () => {
          document.getElementById('inventoryModal').classList.add('hidden');
          currentEstanteInventory = null;
        });

        // Configurar edición masiva
        document.getElementById('editSelectedBtn').addEventListener('click', () => {
          document.getElementById('editSelectedModal').classList.remove('hidden');
        });

        document.getElementById('applyEditBtn').addEventListener('click', () => {
          const name = document.getElementById('editName').value;
          const color = document.getElementById('editColor').value;
          selectedEstantes.forEach(estante => {
            if (name) estante.querySelector('input[type="text"]').value = name;
            estante.querySelector('input[type="color"]').value = color;
            estante.style.backgroundColor = color;
            updateQRCode(estante);
          });
          addHistoryEntry('Editar Múltiples Estantes', `${selectedEstantes.length} estantes editados`);
          saveState();
          document.getElementById('editSelectedModal').classList.add('hidden');
          selectedEstantes = [];
          document.querySelectorAll('.estante-checkbox').forEach(cb => cb.checked = false);
          document.getElementById('editSelectedBtn').classList.add('hidden');
        });

        document.getElementById('closeEditModal').addEventListener('click', () => {
          document.getElementById('editSelectedModal').classList.add('hidden');
        });

        console.log('Inicialización completada');
      } catch (e) {
        console.error('Error en inicialización:', e);
        Swal.fire({
          icon: 'error',
          title: 'Error crítico',
          text: 'No se pudo inicializar la aplicación. Revisa la consola para más detalles.',
        });
      }
    };
  </script>
</body>
</html>